---
paths:
  - "{{LARAVEL_ROOT}}app/**/*.php"
---

# Security Rules

> **Non-negotiable rules** for Laravel security. Violations = vulnerabilities.

## ðŸ”´ Mass Assignment Vulnerability

**ALWAYS define `$fillable` in Models.**

```php
// âŒ CRITICAL ERROR: No $fillable = mass assignment vulnerability
class User extends Model
{
    // Missing $fillable!
}

// âŒ DANGEROUS: Using $request->all()
User::create($request->all());  // Attacker can set is_admin=true

// âœ… CORRECT: Define $fillable explicitly
class User extends Model
{
    protected $fillable = [
        'name_lastname',
        'name_firstname',
        'email',
        'password',
    ];
    
    // $guarded is alternative but $fillable is preferred (explicit)
}

// âœ… CORRECT: Use validated data only
User::create($request->validated());
```

| Rule                                          | Description                                            |
| --------------------------------------------- | ------------------------------------------------------ |
| **Always define `$fillable`**                 | Explicitly list assignable fields                      |
| **Never use `$request->all()`**               | Use `$request->validated()` or `$request->only([...])` |
| **Prefer `$fillable` over `$guarded`**        | Whitelist is safer than blacklist                      |
| **Never put sensitive fields in `$fillable`** | `is_admin`, `role`, `balance` must NOT be fillable     |

---

## ðŸ”´ SQL Injection Prevention

**NEVER use raw user input in queries.**

```php
// âŒ CRITICAL ERROR: SQL Injection vulnerability
$email = $request->input('email');
DB::select("SELECT * FROM users WHERE email = '$email'");  // DANGEROUS!

// âŒ DANGEROUS: String interpolation in whereRaw
User::whereRaw("email = '$email'")->get();  // DANGEROUS!

// âœ… CORRECT: Use parameter binding
DB::select("SELECT * FROM users WHERE email = ?", [$email]);

// âœ… CORRECT: Use Query Builder (auto-escapes)
User::where('email', $email)->get();

// âœ… CORRECT: Parameter binding in whereRaw
User::whereRaw('email = ?', [$email])->get();
```

| Rule                             | Description                        |
| -------------------------------- | ---------------------------------- |
| **Use Query Builder**            | Eloquent auto-escapes values       |
| **Use parameter binding**        | `?` placeholders with array values |
| **Never concatenate user input** | No string interpolation in SQL     |
| **Validate sort fields**         | Whitelist allowed sort columns     |

```php
// âœ… CORRECT: Whitelist sort fields to prevent SQL injection
$allowedSorts = ['id', 'name', 'email', 'created_at'];
$sortBy = in_array($request->sort_by, $allowedSorts) 
    ? $request->sort_by 
    : 'id';
```

---

## ðŸ”´ XSS Prevention

**Always escape output in Blade templates.**

```php
// âŒ DANGEROUS: Raw HTML output
{!! $user->bio !!}  // XSS if bio contains <script>

// âœ… CORRECT: Escaped output (default)
{{ $user->bio }}  // Auto-escapes HTML entities

// âœ… CORRECT: Only use {!! !!} for trusted HTML
{!! $trustedHtml !!}  // Only for admin-generated content
```

---

## ðŸ”´ CSRF Protection

**Never disable CSRF for web routes.**

```php
// âŒ DANGEROUS: Disabling CSRF
// In VerifyCsrfToken middleware
protected $except = ['*'];  // NEVER do this!

// âœ… CORRECT: CSRF is enabled by default for web routes
// API routes use Sanctum tokens instead
```

---

## ðŸ”´ Sensitive Data Exposure

**Hide sensitive fields from JSON responses.**

```php
// âŒ ERROR: Password exposed in API response
return response()->json($user);  // Includes password!

// âœ… CORRECT: Use $hidden in Model
class User extends Model
{
    protected $hidden = [
        'password',
        'remember_token',
        'two_factor_secret',
    ];
}

// âœ… CORRECT: Use Resource to control output
class UserResource extends JsonResource
{
    public function toArray($request): array
    {
        return [
            'id' => $this->id,
            'name' => $this->name,
            // password NOT included
        ];
    }
}
```

---

## Quick Reference

| âŒ Never Do              | âœ… Always Do                       |
| ----------------------- | --------------------------------- |
| `$request->all()`       | `$request->validated()`           |
| Raw SQL with user input | Query Builder / parameter binding |
| Missing `$fillable`     | Define `$fillable` explicitly     |
| Missing `$hidden`       | Hide sensitive fields             |
| Disable CSRF            | Keep CSRF enabled                 |
| `{!! $userInput !!}`    | `{{ $userInput }}`                |
