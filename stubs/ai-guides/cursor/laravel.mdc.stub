---
description: "Laravel backend rules for Omnify projects: schema-first migrations, thin controllers, security patterns, and code generation. Apply when working with Laravel controllers, models, migrations, or API endpoints."
globs: ["{{LARAVEL_BASE}}/**/*.php"]
alwaysApply: false
---

# Laravel Rules

> **Documentation:** `.claude/omnify/guides/laravel/`
> **Team Migration Guide:** `.claude/omnify/guides/laravel/migrations-team.md`
> **Specific Rules:** See also `laravel-controller.mdc`, `laravel-resource.mdc`, `laravel-request.mdc`, `laravel-testing.mdc`, `migrations-workflow.mdc`, `omnify-migrations.mdc`

## ‚õî CRITICAL: DO NOT EDIT

| Path | Reason |
|------|--------|
| `database/migrations/omnify/**` | Auto-generated by Omnify - will be overwritten! |
| `app/Models/OmnifyBase/**` | Auto-generated base models |
| `app/Http/Requests/OmnifyBase/**` | Auto-generated request bases |
| `app/Http/Resources/OmnifyBase/**` | Auto-generated resource bases |

**To modify schema:** Edit YAML in `schemas/` ‚Üí run `npx omnify generate`

---

## Critical Rules

1. **Thin Controller** - Validate ‚Üí Delegate ‚Üí Respond (see `laravel-controller.mdc`)
2. **üö® Schema-First** - **NEVER** run `php artisan make:migration`! Use Omnify schemas instead (see `migrations-workflow.mdc`)
3. **Security** - Always use `$request->validated()`, never `$request->all()`
4. **Performance** - Use `with()` for relations, `paginate()` for lists
5. **Dates** - Store UTC, return `->toISOString()`
6. **Testing** - Write Ê≠£Â∏∏Á≥ª + Áï∞Â∏∏Á≥ª tests (see `laravel-testing.mdc`)
7. **Imports** - Always `use` and short class names, never FQCN inline
8. **OpenAPI Paths** - NO `/api` prefix! `api.php` already has it (see `laravel-controller.mdc`)

## ‚õî FORBIDDEN: Manual Migrations

```bash
# ‚ùå NEVER DO THIS
php artisan make:migration create_xxx_table
php artisan make:migration add_xxx_to_xxx_table

# ‚úÖ ALWAYS DO THIS
# 1. Edit/Create YAML schema in schemas/
# 2. Run: npx omnify generate
# 3. Run: php artisan migrate
```

See `migrations-workflow.mdc` for complete guide.

## File-Specific Rules

| File Type  | Rule File               | Key Focus                    |
| ---------- | ----------------------- | ---------------------------- |
| Controller | `laravel-controller.mdc` | Thin, Query Builder, OpenAPI |
| Resource   | `laravel-resource.mdc`   | Schema matches output        |
| Request    | `laravel-request.mdc`    | Schema matches validation    |
| Test       | `laravel-testing.mdc`    | Ê≠£Â∏∏Á≥ª + Áï∞Â∏∏Á≥ª coverage     |

## Security Checklist

- [ ] `$fillable` defined in Model
- [ ] `$hidden` for sensitive fields
- [ ] `$request->validated()` not `$request->all()`
- [ ] No raw SQL with user input
- [ ] `with()` for eager loading
- [ ] `whenLoaded()` in Resources
- [ ] `paginate()` for list endpoints

## When to Use What

| Scenario         | Solution           |
| ---------------- | ------------------ |
| Simple CRUD      | Controller + Model |
| Multi-step logic | Service            |
| Reusable action  | Action class       |
| Async task       | Job                |

## Authentication Models

When `authenticatable: true` is set in schema, model extends `Authenticatable`:

```yaml
# schemas/auth/User.yaml
options:
  authenticatable: true
  authenticatableLoginIdField: email
  authenticatablePasswordField: password
  authenticatableGuardName: web  # Optional: for multi-guard
```

**Required `config/auth.php` for custom guards:**

```php
'guards' => [
    'admin' => ['driver' => 'session', 'provider' => 'admins'],
],
'providers' => [
    'admins' => ['driver' => 'eloquent', 'model' => App\Models\Admin::class],
],
```

**See:** `.claude/omnify/guides/omnify/schema-guide.md` ‚Üí "Authenticatable Option - Detailed Guide"

## Pre-Edit Checklist

**BEFORE editing any file, MUST:**

1. **Read the file first** - Check existing imports, patterns, style
2. **Check imports** - Add `use` if class not imported
3. **Follow existing style** - Match indentation, naming, patterns
4. **Never use FQCN inline** - Always import first

## Imports Rule

```php
// ‚ùå WRONG: Inline FQCN
public function store(): \Illuminate\Http\JsonResponse

// ‚úÖ CORRECT: Import and use short name
use Illuminate\Http\JsonResponse;
public function store(): JsonResponse
```

## Don't Over-Engineer

| ‚ùå DON'T                             | ‚úÖ DO                      |
| ----------------------------------- | ------------------------- |
| Add workaround to hide bugs         | Fix root cause or report  |
| Repository for simple CRUD          | Use Eloquent directly     |
| Service that just wraps Model       | Controller + Model        |
| Interface with 1 implementation     | Concrete class            |
| Manual 404 check with route binding | Trust framework           |
| "Improve" unrelated code            | Change only what's needed |
| Build for future "just in case"     | YAGNI - build when needed |

**Full examples:** `.claude/omnify/guides/laravel/architecture.md`
