---
description: "User-editable form requests. MUST read corresponding BaseRequest before editing to avoid duplicating auto-generated validation rules."
globs: ["{{LARAVEL_BASE}}/Http/Requests/*.php"]
alwaysApply: true
---

# Request Editing Rules

These are **user-editable** request files that extend auto-generated BaseRequests.

## ⚠️ BEFORE EDITING - MANDATORY STEPS

### 1. Read the BaseRequest First

Before editing `PostStoreRequest.php`, you **MUST** read `OmnifyBase/PostStoreRequestBase.php` to understand:
- What validation rules already exist
- What messages are defined
- What attributes are set

### 2. Check for Existing Rules

If a rule exists in BaseRequest, **DO NOT** duplicate it here.

## ❌ NEVER DUPLICATE

```php
// These are ALREADY in BaseRequest - NEVER recreate!
'title' => ['required', 'string', 'max:255'],  // ❌ From schema
'email' => ['required', 'email'],               // ❌ From schema
'status' => ['required', 'in:draft,published'], // ❌ From enum
```

## ✅ ONLY ADD Custom Validation

```php
class PostStoreRequest extends PostStoreRequestBase
{
    /**
     * Merge custom rules with base rules
     */
    public function rules(): array
    {
        return array_merge(parent::rules(), [
            // ✅ Unique constraint (database-specific)
            'slug' => ['unique:posts,slug'],
            
            // ✅ Complex business rules
            'published_at' => ['required_if:status,published'],
            
            // ✅ Custom format validation
            'featured_image' => ['url', 'regex:/\.(jpg|png|webp)$/i'],
        ]);
    }

    /**
     * Add custom validation logic
     */
    public function withValidator($validator): void
    {
        $validator->after(function ($validator) {
            // ✅ Cross-field validation
            if ($this->status === 'published' && empty($this->content)) {
                $validator->errors()->add('content', 'Content is required for published posts.');
            }
        });
    }

    /**
     * Custom authorization logic
     */
    public function authorize(): bool
    {
        // ✅ Add authorization check
        return $this->user()->can('create', Post::class);
    }

    /**
     * Prepare data before validation
     */
    protected function prepareForValidation(): void
    {
        // ✅ Data transformation
        $this->merge([
            'slug' => Str::slug($this->title),
        ]);
    }
}
```

## For Update Requests

```php
class PostUpdateRequest extends PostUpdateRequestBase
{
    public function rules(): array
    {
        return array_merge(parent::rules(), [
            // ✅ Ignore current record for unique check
            'slug' => ['unique:posts,slug,' . $this->route('post')],
        ]);
    }
}
```

## Quick Checklist Before Saving

- [ ] Read `OmnifyBase/{Request}Base.php` first
- [ ] Not duplicating validation rules from BaseRequest
- [ ] Using `array_merge(parent::rules(), [...])` pattern
- [ ] Only adding custom/complex validation
- [ ] Using `parent::authorize()` if BaseRequest has authorization
