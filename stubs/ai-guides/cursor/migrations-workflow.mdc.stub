---
description: "Schema-first workflow for database changes. NEVER use php artisan make:migration - always edit schemas/*.yaml and run npx omnify generate instead. This rule enforces the correct workflow when working with migrations."
globs: ["{{LARAVEL_ROOT}}database/migrations/*.php"]
alwaysApply: true
---

# â›” STOP: DO NOT CREATE MIGRATIONS MANUALLY

## You MUST use Omnify Schema to create database changes

When you need to modify the database structure, **NEVER** run:

```bash
# âŒ FORBIDDEN
php artisan make:migration create_xxx_table
php artisan make:migration add_xxx_to_xxx_table
php artisan make:migration modify_xxx_column
```

---

## âœ… CORRECT WORKFLOW

### Step 1: Create or Edit Schema YAML

```yaml
# schemas/your-module/YourModel.yaml
displayName:
  ja: ãƒ¢ãƒ‡ãƒ«å
  en: Model Name

properties:
  field_name:
    type: String
    length: 255
    displayName:
      ja: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
      en: Field Name
```

### Step 2: Generate Migrations

```bash
npx omnify generate
```

### Step 3: Run Migrations

```bash
php artisan migrate
```

---

## Why This Rule Exists

| Manual Migration | Omnify Schema |
|------------------|---------------|
| âŒ No TypeScript types | âœ… Auto-generated types |
| âŒ No i18n labels | âœ… Auto-generated i18n |
| âŒ No Zod validation | âœ… Auto-generated validation |
| âŒ No API resources | âœ… Auto-generated API |
| âŒ Inconsistent naming | âœ… Consistent naming |
| âŒ Manual model updates | âœ… Auto-updated models |

---

## Schema-First Development Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SCHEMA YAML (Source of Truth)            â”‚
â”‚               schemas/module/ModelName.yaml                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼ npx omnify generate
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Migrations    â”‚    â”‚   Laravel       â”‚   â”‚   TypeScript    â”‚
â”‚   (PHP)         â”‚    â”‚   Models        â”‚   â”‚   Types/Zod     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                 â”‚
         â–¼                         â–¼                 â–¼
    php artisan              Ready to use        Frontend ready
      migrate
```

---

## ðŸš¨ BEFORE Creating Any Migration

### Ask yourself:

1. **Can this be done with Omnify Schema?**
   - New table? â†’ Create new YAML schema
   - New column? â†’ Add property to YAML
   - New index? â†’ Add `index: true` to property
   - Foreign key? â†’ Add association to YAML

2. **Is this schema-related?**
   - YES â†’ Edit YAML, run `npx omnify generate`
   - NO â†’ Only then consider manual migration

---

## When Manual Migrations ARE Allowed

Only for operations **NOT supported** by Omnify:

```bash
# âœ… ALLOWED: Data migrations (not schema changes)
php artisan make:migration migrate_old_data_to_new_format

# âœ… ALLOWED: Complex SQL operations
php artisan make:migration add_full_text_search_index

# âœ… ALLOWED: Third-party package migrations
php artisan vendor:publish --tag=package-migrations
```

**BUT NEVER for standard CRUD tables/columns!**

---

## Quick Reference: Schema vs Manual

| Change Type | Use Omnify Schema | Manual OK |
|-------------|:-----------------:|:---------:|
| Create table | âœ… | âŒ |
| Add column | âœ… | âŒ |
| Modify column | âœ… | âŒ |
| Add foreign key | âœ… | âŒ |
| Add simple index | âœ… | âŒ |
| Add pivot table | âœ… | âŒ |
| Add enum column | âœ… | âŒ |
| Data migration | âŒ | âœ… |
| Full-text index | âŒ | âœ… |
| Raw SQL changes | âŒ | âœ… |

---

## How to Add Common Schema Changes

### New Table

```yaml
# schemas/shop/Product.yaml
displayName:
  ja: å•†å“
  en: Product

properties:
  name:
    type: String
    length: 255
  price:
    type: Decimal
    precision: 10
    scale: 2
```

### New Column to Existing Table

```yaml
# Edit existing schemas/shop/Product.yaml
properties:
  # ... existing properties ...
  
  # Add new property
  sku:
    type: String
    length: 50
    unique: true
```

### Add Relationship

```yaml
# schemas/shop/Product.yaml
associations:
  category:
    type: ManyToOne
    target: Category
    foreignKey: category_id
```

### Add Index

```yaml
properties:
  email:
    type: String
    index: true  # Simple index
    
  # Or composite index
indexes:
  - columns: [first_name, last_name]
    unique: true
```

---

## Remember

> **Schema YAML = Single Source of Truth**
> 
> All database structure changes should originate from YAML schemas.
> The migration files are just **generated output**, not the source.

---

## If You're Unsure

Read the schema guide:

```bash
cat .cursor/rules/omnify/schema-create.mdc
# or
cat schemas/README.md
```

Or ask:
> "How do I add [field/table/relationship] using Omnify schema?"
